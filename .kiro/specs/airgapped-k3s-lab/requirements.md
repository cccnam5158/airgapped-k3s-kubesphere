# 요구사항 문서

## 소개

Windows 10/11 환경에서 VMware Workstation Pro를 사용하여 완전히 오프라인으로 k3s 클러스터와 KubeSphere를 구축하는 에어갭 쿠버네티스 랩 환경 시스템입니다. 이 시스템은 인터넷 연결 없이 모든 구성 요소를 실행할 수 있으며, 스크립트 기반 자동 설치 및 구성을 제공합니다.

## 요구사항

### 요구사항 1

**사용자 스토리:** 시스템 관리자로서, Windows 환경에서 완전히 오프라인으로 쿠버네티스 클러스터를 구축하고 싶습니다. 이를 통해 보안이 중요한 환경에서도 쿠버네티스를 학습하고 테스트할 수 있습니다.

#### 승인 기준

1. WHEN 사용자가 환경 검증 스크립트를 실행하면 THEN 시스템은 Windows 10/11 Pro, VMware Workstation Pro 16+, WSL2 Ubuntu 22.04 LTS의 설치 상태를 확인해야 합니다
2. WHEN 모든 사전 요구사항이 충족되면 THEN 시스템은 관리자 권한과 최소 16GB 메모리, 20GB 디스크 공간을 검증해야 합니다
3. WHEN 환경 검증이 완료되면 THEN 시스템은 VMware 네트워크(VMnet1, 192.168.6.0/24) 설정을 확인해야 합니다

### 요구사항 2

**사용자 스토리:** 개발자로서, 오프라인 환경에서 필요한 모든 컨테이너 이미지와 바이너리를 미리 준비하고 싶습니다. 이를 통해 인터넷 연결 없이도 완전한 쿠버네티스 환경을 구축할 수 있습니다.

#### 승인 기준

1. WHEN 오프라인 준비 스크립트를 실행하면 THEN 시스템은 로컬 Docker 레지스트리(localhost:5000)를 시작해야 합니다
2. WHEN 이미지 미러링을 수행하면 THEN 시스템은 26개의 필수 컨테이너 이미지(Kubernetes Core 4개, KubeSphere Core 2개, Monitoring 3개, Prometheus Stack 2개, Grafana 1개, Rancher Mirrored 4개, Additional 2개)를 다운로드하고 미러링해야 합니다
3. WHEN k3s 바이너리 다운로드를 수행하면 THEN 시스템은 k3s v1.33.4-rc1+k3s1 바이너리와 에어갭 이미지(636MB)를 다운로드해야 합니다
4. WHEN 보안 설정을 구성하면 THEN 시스템은 SSH 키 쌍, TLS 인증서(SAN 포함), registries.yaml 설정 파일을 생성해야 합니다

### 요구사항 3

**사용자 스토리:** 시스템 관리자로서, Ubuntu 22.04.5 LTS 기반의 VM을 자동으로 생성하고 설정하고 싶습니다. 이를 통해 수동 설치 과정 없이 일관된 환경을 구축할 수 있습니다.

#### 승인 기준

1. WHEN Seed ISO 생성을 실행하면 THEN 시스템은 Ubuntu 22.04.5 LTS 기반의 cloud-init 자동 설치 ISO를 생성해야 합니다
2. WHEN VM 생성 스크립트를 실행하면 THEN 시스템은 1개의 마스터 노드(192.168.6.10)와 2개의 워커 노드(192.168.6.11, 192.168.6.12)를 자동 생성해야 합니다
3. WHEN VM이 부팅되면 THEN 시스템은 cloud-init을 통해 자동으로 Ubuntu를 설치하고 필요한 패키지(jq, htop, ethtool, iproute2, dnsutils, telnet, psmisc, sysstat, iftop, iotop, dstat, yq)를 설치해야 합니다
4. WHEN 설치가 완료되면 THEN 시스템은 SSH 키 기반 인증을 설정하고 패스워드 인증을 비활성화해야 합니다

### 요구사항 4

**사용자 스토리:** 쿠버네티스 관리자로서, k3s 클러스터가 자동으로 구성되고 KubeSphere가 설치되기를 원합니다. 이를 통해 복잡한 수동 설정 없이 완전한 쿠버네티스 환경을 사용할 수 있습니다.

#### 승인 기준

1. WHEN 마스터 노드가 부팅되면 THEN 시스템은 k3s 서버를 자동으로 시작하고 클러스터를 초기화해야 합니다
2. WHEN 워커 노드가 부팅되면 THEN 시스템은 자동으로 마스터 노드에 조인해야 합니다
3. WHEN 클러스터가 구성되면 THEN 시스템은 KubeSphere v4.1.3 컴포넌트를 자동으로 배포해야 합니다
4. WHEN KubeSphere 설치가 완료되면 THEN 시스템은 웹 콘솔(http://192.168.6.10:30880)을 통해 접근 가능해야 합니다

### 요구사항 5

**사용자 스토리:** 개발자로서, WSL2 환경에서 직접 kubectl을 사용하여 VM 클러스터에 접근하고 싶습니다. 이를 통해 별도의 SSH 접속 없이도 쿠버네티스 리소스를 관리할 수 있습니다.

#### 승인 기준

1. WHEN 클러스터 확인 스크립트를 실행하면 THEN 시스템은 VM들의 SSH 연결과 k3s 서비스 상태를 점검해야 합니다
2. WHEN kubectl 설정을 수행하면 THEN 시스템은 kubeconfig 파일을 자동으로 다운로드하고 서버 주소를 VM IP로 수정해야 합니다
3. WHEN TLS 인증서 문제가 발생하면 THEN 시스템은 자동으로 CA 인증서를 설정하거나 insecure 플래그를 사용해야 합니다
4. WHEN WSL kubectl 접속이 완료되면 THEN 사용자는 `kubectl get nodes -o wide` 명령으로 클러스터 상태를 확인할 수 있어야 합니다

### 요구사항 6

**사용자 스토리:** 시스템 관리자로서, 시간 동기화 문제로 인한 TLS 인증서 오류를 방지하고 싶습니다. 이를 통해 오프라인 환경에서도 안정적인 클러스터 운영이 가능합니다.

#### 승인 기준

1. WHEN VM이 부팅되면 THEN 시스템은 sync-time.service를 실행하여 WSL 레지스트리의 HTTP Date 헤더로 시간을 동기화해야 합니다
2. WHEN 레지스트리 접근이 불가능하면 THEN 시스템은 ISO에 포함된 build-timestamp를 사용하여 시간을 설정해야 합니다
3. WHEN 시간 동기화가 완료되면 THEN 시스템은 hwclock --systohc로 하드웨어 클록을 저장해야 합니다
4. WHEN k3s 서비스가 시작되면 THEN 시스템은 sync-time.service 완료 후에 실행되어야 합니다

### 요구사항 7

**사용자 스토리:** 시스템 관리자로서, VM 재부팅 시 불필요한 재설치가 발생하지 않기를 원합니다. 이를 통해 안정적인 클러스터 운영과 개발 환경을 유지할 수 있습니다.

#### 승인 기준

1. WHEN VM 설치가 완료되면 THEN 시스템은 부팅 순서를 disk,cdrom으로 변경해야 합니다
2. WHEN cloud-init 설정 단계가 실행되면 THEN 시스템은 각 단계마다 완료 표시 파일을 생성해야 합니다
3. WHEN VM이 재부팅되면 THEN 시스템은 완료 표시 파일을 확인하여 중복 실행을 방지해야 합니다
4. WHEN ISO 파일 복사가 완료되면 THEN 시스템은 자동으로 VMware ISO 연결을 해제해야 합니다

### 요구사항 8

**사용자 스토리:** 개발자로서, 네트워크 격리된 환경에서 프라이빗 레지스트리를 통해 컨테이너 이미지에 접근하고 싶습니다. 이를 통해 보안이 중요한 환경에서도 컨테이너 워크로드를 실행할 수 있습니다.

#### 승인 기준

1. WHEN 포트 포워딩을 설정하면 THEN 시스템은 Windows에서 WSL2 레지스트리(5000번 포트)로의 접근을 허용해야 합니다
2. WHEN VM에서 레지스트리에 접근하면 THEN 시스템은 TLS SAN이 포함된 인증서로 https://192.168.6.1:5000 접속을 허용해야 합니다
3. WHEN kubelet이 이미지를 pull하면 THEN 시스템은 registries.yaml 설정을 통해 로컬 레지스트리에서 이미지를 가져와야 합니다
4. WHEN 레지스트리 카탈로그를 조회하면 THEN 시스템은 미러링된 26개 이미지 목록을 반환해야 합니다